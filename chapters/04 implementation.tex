\chapter{Implementation} 
\label{chapter:implementation}
This chapter describes the design of smart contracts and provides the detailed implementation of each function that is adopted in this paper. The smart contract diagram as shown in Figure~\ref{fig:smart_contract_diagram},  all of the organizations have common \(OMgr\) for managing users' information and storing users' status. The ecosystem initiator enables blockchain-based functionality by deploying a \(OMgr\). It offers application binary interface (ABI) files for all participants to easily call smart contract functions.

\begin{figure}[hb]
    \centering
    \includegraphics[height=!,width=1\linewidth,keepaspectratio=true]{figures/smart_contract_diagram.png}
    \caption{{\footnotesize Smart Contract Diagram}}
    \label{fig:smart_contract_diagram}
\end{figure}
\section{Smart contract design}
\subsection*{Organization Manager}
The \(OMgr\) is used to manage information that is related to users and organizations, i.e., it records data attributes, users' identity hash value. In Table~\ref{table:userinfo}, the \textit{UserInfo} structure represents an independent \(DI\). After the identity verification process is done as shown in Figure~\ref{fig:identityVerification}, the \(DI\) will be created for users automatically.\par
Because every organization has one key pair for determined their identity, we can retrieve their address from the private key and then append these addresses to the variable \(org\) in \(OMgr\).\par

\input{tables/table-userinfo}

This smart contract provides functions to create user identity, bind account with Ethereum address, and create exclusive \(ACMgr\) for the user as shown in Figure~\ref{fig:smart_contract_deployment}. And it also defines events in order that the smart contract can emit events to record logs on the block. That enables traceability of identity creation processes. The most important functions we used in \(OMgr\) are \textit{addUser}, \textit{bindAccount} and only the legitimate organizations are able to trigger these functions.\par 
The function \textit{addUser} is invoked after finishing identity verification, the \(OMgr\) check whether the \(ID\) exist on the blockchain. Then if the \(ID\) is new one, the \(OMgr\) will create \textit{UserInfo} for users. Otherwise, the \(OMgr\) will append the address of \(Org\) who triggers this function to the variable \textit{orgs} in \textit{UserInfo}.\par 
The function \textit{bindAccount} is used to bind user's \(DI\) to Ethereum address. So that every contract \(ACMgr\) will record organizations which the user has registered. One \(DI\) only corresponds to one Ethereum address,  to establish a contract for storing access right.\par 

\subsection*{Access Manager}
After binding to address, contract \(ACMgr\) will be created and its owner belongs to users, i.e., the user has full right to manage its contract and authorize access right to any legitimate organization. And users have a full right to make their choice as to whether or not to allow personal data opened. This contract uses two mappings to store access right in the form of key and value pairs where every key is unique. These keys represent attribute names that \(RA\) approves and submits. It is necessary to formulate data attributes for users and organizations by \(RA\) because financial data attributes will update dynamically and only \(RA\) can update these attributes. For example, the Financial Supervisory Commission (FSC) was in charge of the development, supervision, regulation, and examination of financial services in Taiwan.

\begin{figure}[htb]
    \centering
    \includegraphics[height=!,width=0.8\linewidth,keepaspectratio=true]{figures/smart_contract_deployment.png}
    \caption{{\footnotesize The relation between smart contracts}}
    \label{fig:smart_contract_deployment}
\end{figure}
For the purpose of delivering a better user experience, we designed two access authorization modes for access personal data. If the \(C_N\) want to allow \(TSP\) to access the data from all \(Org\) ($Bank$), the \(C_N\) needs to authorize access many times due to one on one authorization, it is called Mode 1 as shown in Table~\ref{table:accessStruct}. Another mode is one-to-many, the user only needs to select the attribute name that the user wants to share. Afterward, all the legitimate banks will accept any data request from \(TSP\)  against the selected attribute.
\input{tables/table-acmgr.tex}

\newpage

\section{Third Party Login}

\begin{figure}[htb]
    \centering
    \includegraphics[height=!,width=1\linewidth,keepaspectratio=true]{figures/traditional_decentralized.png}
    \caption{{\footnotesize Traditional vs. Decentralized login}}
    \label{fig:traditional_decentralized}
\end{figure}

In contrast to traditional login as shown in Figure~\ref{fig:traditional_decentralized}, the user can log in to other organizations with decentralized login and it doesn't need to remember any password, because the unique \(DI\) store on blockchain and the server can verify the user's identity by validating the signature that the user sign its hashed \(ID\).\par
Our framework supports both of login mechanisms and utilizes hashed \(ID\) as the primary key to restoring user account information that the user stores on the LDAP server. Before binding account, the hashed \(ID\) doesn't establish yet and leave the hashed field empty.\par 
To begin this decentralized login process, the client should install the MetaMask extension on Chrome browser and import existed private key or register a new one. The first step in this process was to use \textit{call} function to view the user's hashed \(ID\) from blockchain. The second step was to sign the hashed \(ID\) by the user's private key using ECDSA. The final step was confirm with blockchain by server and then retrieve user account information.

\section{Account Integration}
In existing systems, users have an obligation to remember their own username/password pairs as users register a new one. Furthermore, because these pairs are following different rules, such as at least upper and lower case letters, character, symbol. It would be difficult for users to manage these pairs that are distributed and messy. There are several tangible solutions for storing these pairs nowadays. For instance, 1password and LastPass are password managers that save your username and password to cloud storage. But they cost money and users are required to trust a third party that controls their personal information. Besides, some services and platforms have already had their extreme vulnerability. Instead, we propose an account integration solution, which makes use of blockchain technology to generate tamper-proof record and realize access control.\par 
In order to effectively perform account integration without a single authority entity, we took advantage of a secure hash algorithm and blockchain smart contracts that execute when the specific conditions are met. In the proposed architecture, the user has a secure and convenient way to build their own account integration via smart contracts on the blockchain, as depicted below.

\renewcommand\labelenumi{(\theenumi)}
\begin{enumerate}[noitemsep, topsep=0pt]
    \item A \(C_i\) registers organization accounts respectively, these accounts are relatively independent of each other.
    \item One of the organizations creates DI using a hash algorithm Keccak-256  on blockchain as \(C_i\) passes real-name authentication, the others append their organization address to the same DI.
    \item After establishing an identity, the \(C_i\) will propose an account binding request when the \(C_i\) wants to participant in this ecosystem.
    \item One organization that the \(C_i\) registers with receives this request and then creates a transaction signed by its organization's private key to bind these accounts to the Ethereum address that the \(C_i\) specify. 
    \item Afterward, the \(C_i\) can use the bound address to sign in or sign up for organizations within this ecosystem.
\end{enumerate}

\begin{figure}[htb]
    \centering
    \includegraphics[height=!,width=1\linewidth,keepaspectratio=true]{figures/account_integration.png}
    \caption{{\footnotesize Account integration}}
    \label{fig:account_integration}
\end{figure}

As the Figure~\ref{fig:account_integration} shows a scenario, where a user uses the bound address to find an organization account for sign-in organization's service.  This account integration has brought benefits to users such as ease of management, sign-up without additional registration, as well as no more information to be revealed to the public.

\newpage
\section{Data Sharing}


\newpage

\section{Token design}
\input{tables/table-jwt.tex}